<!DOCTYPE html>
<html>
  <head>
    <title>rFactor 2 - Day Planner - Race Control</title>
    <meta charset="utf-8" />
    <style type="text/css">
      :root {
        --Color-Primary: #A30000;
      }
      body {
        color: #707070;
        font-size: 16px;
        font-family: sans-serif;
        margin: 0;
        background-color: #333333;
      }
      .wrapper {
        display: flex;
        padding: 80px 32px;
        flex-direction: column;
        align-items: center;
        gap: 80px;
      }
      h2 {
        font-family: sans-serif;
        font-size: 2.5em;
        font-style: normal;
        font-weight: 700;
        line-height: normal;
      }
      h3 {
        font-family: sans-serif;
        font-size: 2em;
        font-style: normal;
        font-weight: 400;
        line-height: normal;
      }
      .primary-content {
        font-family: sans-serif;
        font-size: 1.75em;
        font-style: normal;
        font-weight: 400;
        line-height: normal;
        margin: 0;
      }
      .secundary-content {
        font-family: sans-serif;
        font-size: 1.5em;
        font-style: normal;
        font-weight: 400;
        line-height: normal;
        margin: 0;
      }
      #events-container {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 40px;
      }
      .levels {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        gap: 40px;
        flex: 1 0 0;
      }
      .event {
        box-sizing: border-box;
        display: flex;
        width: 100%;
        align-items: flex-start;
        gap: 16px;
        border-radius: 16px;
        background: #000;
        padding: 32px;
      }
      .hour {
        display: flex;
        padding: 0;
        margin: 0;
        align-items: center;
        align-self: stretch;
        color: var(--Color-Primary);
        font-family: sans-serif;
        font-size: 3.5em;
        font-style: normal;
        font-weight: 700;
        line-height: normal;
      }
      .event-name {
        margin: 0;
      }
      .event-col {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 24px;
        flex: 1 0 0;
        align-self: stretch;
      }
      .car-track {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .row-car-track {
        display: flex;
        flex-direction: row;
        gap: 16px;
        align-items: center;
        box-sizing: border-box;
        height: 32px;
      }
      .row-car-track p {
        margin: 0;
        padding: 0;
        text-transform: uppercase;
      }
      .levels-hour {
        display: flex;
        flex-direction: row;
        gap: 16px;
      }
      .agendar {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
        align-self: stretch;
        border-radius: 16px;
        background: var(--Color-Primary);
        color: #FFF;
        font-family: sans-serif;
        font-size: 2.5em;
        font-style: normal;
        font-weight: 400;
        line-height: normal;
        padding: 24px;
        border: none;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <h1><img src="logo-rf-planner.svg" alt="rF Planner Pro" /></h1>
      <div id="events-container">

        <!--
        <div class="levels">
          <div><h2>Iniciante |</h2><p>Corridas a cada 1 hora</p></div>
          <div id="list-iniciante"></div>
        </div>

        <div class="levels">
          <div><h2>Intermediário |</h2><p>Corridas a cada 1 hora</p></div>
          <div id="list-intermediario"></div>
        </div>

        <div class="levels">
          <div><h2>Avançado |</h2><p>Corridas a cada 2 hora</p></div>
          <div id="list-avancado"></div>
        </div>
        -->

      </div>
    </div>
    <script type="text/javascript">

      const preconfig = [
        {
          "id": "Beginner-1",
          "level": "beginner",
          "EventName": "Radical Reindeers",
          "car": "Radical SR3-RSX",
          "track": "Adria Raceway Full Circuit",
          "eventDuration": "32",
          "duration": "P: 6m | Q: 5m | R: 16m",
          "Rank Impact DR": "Low",
          "Rank Impact SR": "Very low"
        },
        {
          "id": "Beginner-2",
          "level": "beginner",
          "EventName": "Open Sleigh Sprint",
          "car": "Tatuus USF-17",
          "track": "Indianapolis Motor Speedway GP",
          "eventDuration": "32",
          "duration": "P: 6m | Q: 5m | R: 16m",
          "Rank Impact DR": "Low",
          "Rank Impact SR": "Very low"
        },
        {
          "id": "Beginner-3",
          "level": "beginner",
          "EventName": "Tinsel Cup",
          "car": "Caterham Academy",
          "track": "Mills Metro Park Inner Loop A",
          "eventDuration": "32",
          "duration": "P: 6m | Q: 5m | R: 16m",
          "Rank Impact DR": "Low",
          "Rank Impact SR": "Very low"
        },
        {
          "id": "Intermediate-1",
          "level": "intermediate",
          "EventName": "Christmas Pudding",
          "car": "Mini Coopers",
          "track": "Donington Park National",
          "eventDuration": "50",
          "duration": "P: 10m | Q: 10m | R: 25m",
          "Rank Impact DR": "Low",
          "Rank Impact SR": "Very low"
        },
        {
          "id": "Intermediate-2",
          "level": "intermediate",
          "EventName": "Snowtypes",
          "car": "(2 cars) Prototypes",
          "track": "Bahrain International Circuit GP",
          "eventDuration": "50",
          "duration": "P: 10m | Q: 10m | R: 25m",
          "Rank Impact DR": "Low",
          "Rank Impact SR": "Very low"
        },
        {
          "id": "Advanced-1",
          "level": "advanced",
          "EventName": "100% Charged",
          "car": "Formula E GEN3 2023",
          "track": "Long Beach GP Street Circuit",
          "eventDuration": "51",
          "duration": "P: 10m | Q: 10m | R: 26m",
          "Rank Impact DR": "Low",
          "Rank Impact SR": "Very low"
        }
      ]

      const CLIENT_ID = '619709126766-c7qvb5a1j0vmsdpc7vtlsvbvclgbk2md.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyCZxOveemWCNaUdw8RC3WGv_9CPCBmEODI';
      const CALENDAR_ID = '78oq61mmrpcs9uosbp4esgcs6s@group.calendar.google.com';

      // Discovery doc URL for APIs used by the quickstart
      const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';

      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;

      /**
       * Callback after api.js is loaded.
       */
      function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
      }

      /**
       * Callback after the API client is loaded. Loads the
       * discovery doc to initialize the API.
       */
      async function initializeGapiClient() {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
        listUpcomingEvents();
      }

      /**
       * Callback after Google Identity Services are loaded.
       */
      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: '', // defined later
        });
        gisInited = true;
      }

      /**
       * Print the summary and start datetime/date of the next ten events in
       * the authorized user's calendar. If no events are found an
       * appropriate message is printed.
       */
      async function listUpcomingEvents() {
        let response;
        try {

          const dataAtual = new Date();
          dataAtual.setHours(dataAtual.getHours() + 1);
          const inicioDoDia = dataAtual.toISOString();

          const fimDoDia = new Date();
          fimDoDia.setHours(23, 59, 59, 999);
          const fimDoDiaISOString = fimDoDia.toISOString();

          const request = {
            'calendarId': CALENDAR_ID,
            'timeMin': inicioDoDia,
            'timeMax': fimDoDiaISOString,
            'showDeleted': false,
            'singleEvents': true,
            'orderBy': 'startTime',
          };
          response = await gapi.client.calendar.events.list(request);
        } catch (err) {
          return;
        }

        const events = response.result.items;
        const listIniciante = document.getElementById('list-iniciante');
        const listIntermediario = document.getElementById('list-intermediario');
        const listAvancado = document.getElementById('list-avancado');
        const eventsContainer = document.getElementById('events-container');
        const data = {};
        const html = events.map(event => {
          const dateTime = hour(event.start.dateTime);
          
          preconfig.map(config => {
            if(event.summary === config.id) {
              data['id'] = config.id;
              data['level'] = config.level;
              data['EventName'] = config.EventName;
              data['car'] = config.car;
              data['track'] = config.track;
              data['duration'] = config.duration;
            }
          })

          let levels = "";

          switch (data['level']) {
            case 'beginner':
              levels = "./Status=Bronze.svg?v=1";
              break;
            case 'intermediate':
              levels = "./Status=Prata.svg?v=1";
              break;
            case 'advanced':
              levels = "./Status=Ouro.svg?v=1";
              break;
          }

          return `
            <div class="event">
              <div class="event-col">
                <h2 class="event-name">${data.EventName}</h2>
                <div class="levels-hour">
                  <img height="64px" width="64px" src="${levels}" />
                  <div>
                    <p class="hour">${dateTime}</p>
                    <p class="secundary-content">${data.duration}</p>
                  </div>
                </div>
                <div class="car-track">
                  <div class="row-car-track"><img width="32px" height="32px" src="./car-svgrepo-com.svg"/><p class="primary-content">${data.car}</p></div>
                  <div class="row-car-track"><img width="32px" height="32px" src="./road-svgrepo-com.svg"/><p class="primary-content">${data.track}</p></div>
                </div>
              </div>
              <button class="agendar" data-info='{"event-name": ${data.EventName}}'>Agendar</button>
            </div>
          `;
        }).join('');

        if(data.level === "beginner") {
          eventsContainer.innerHTML = html;
        }

        if(data.level === "intermediate") {
          eventsContainer.innerHTML = html;
        }

        if(data.level === "advanced") {
          eventsContainer.innerHTML = html;
        }

        document.querySelectorAll('.agendar').forEach(botao => {
          botao.addEventListener('click', function(event) {
            //this.getAttribute('data-info')
            iniciarAutenticacao();
          });
        });
        
      }

      function hour(dataHora) {
        const data = new Date(dataHora);
        return data.toLocaleTimeString('pt-BR', { hour: 'numeric', minute: 'numeric' })
      }

      function iniciarAutenticacao() {
        const SCOPES2 = 'https://www.googleapis.com/auth/calendar';

        gapi.auth.authorize({
          client_id: CLIENT_ID,
          scope: SCOPES2,
          immediate: false
        }, function(authResult) {
          if (authResult && !authResult.error) {
            // Autenticação bem-sucedida, criar o evento
            criarEvento(authResult.access_token);
          } else {
            // Tratar erro de autenticação
            console.error('Erro ao autenticar:', authResult.error);
          }
        });
      }

      // Função para criar um evento na agenda do usuário
      function criarEvento(access_token) {
        const calendar = gapi.client.calendar;
        
        const evento = {
          'summary': 'Reunião Importante',
          'location': 'Local da Reunião',
          'description': 'Discussão sobre o projeto X',
          'start': {
            'dateTime': '2023-12-25T09:00:00-03:00',
            'timeZone': 'America/Sao_Paulo',
          },
          'end': {
            'dateTime': '2023-12-25T10:00:00-03:00',
            'timeZone': 'America/Sao_Paulo',
          },
        };

        calendar.events.insert({
          calendarId: 'primary',
          resource: evento,
          auth: access_token
        }).then(eventoCriado => {
          console.log('Evento criado:', eventoCriado.result.htmlLink);
        }).catch(err => {
          console.error('Erro ao criar evento:', err);
        });
      }

    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  </body>
</html>
